# Test info

- Name: Authentication API >> should get user profile with valid token
- Location: /home/ramonkey/Developer/fs1-mern/back/tests/api/auth.test.js:114:3

# Error details

```
Error: expect(received).toBe(expected) // Object.is equality

Expected: 200
Received: 401
    at /home/ramonkey/Developer/fs1-mern/back/tests/api/auth.test.js:121:31
```

# Test source

```ts
   21 |   test.beforeAll(async () => {
   22 |     const isHealthy = await checkServerHealth();
   23 |     if (!isHealthy) {
   24 |       throw new Error('Server is not running. Please start with: npm run dev');
   25 |     }
   26 |   });
   27 |
   28 |   test('should register a new user', async ({ request }) => {
   29 |     const response = await request.post('/api/auth/register', {
   30 |       data: testUser
   31 |     });
   32 |     
   33 |     expect(response.status()).toBe(201);
   34 |     const body = await response.json();
   35 |     expect(body).toHaveProperty('token');
   36 |     expect(body).toHaveProperty('user');
   37 |     expect(body.user.email).toBe(testUser.email);
   38 |     expect(body.user.firstName).toBe(testUser.firstName);
   39 |     expect(body.user).not.toHaveProperty('password');
   40 |     
   41 |     authToken = body.token;
   42 |   });
   43 |
   44 |   test('should not register user with invalid email', async ({ request }) => {
   45 |     const response = await request.post('/api/auth/register', {
   46 |       data: {
   47 |         ...testUser,
   48 |         email: 'invalid-email'
   49 |       }
   50 |     });
   51 |     
   52 |     expect(response.status()).toBe(400);
   53 |   });
   54 |
   55 |   test('should not register user with weak password', async ({ request }) => {
   56 |     const response = await request.post('/api/auth/register', {
   57 |       data: {
   58 |         ...testUser,
   59 |         email: `another_${Date.now()}@example.com`,
   60 |         password: '123'
   61 |       }
   62 |     });
   63 |     
   64 |     expect(response.status()).toBe(400);
   65 |   });
   66 |
   67 |   test('should not register duplicate email', async ({ request }) => {
   68 |     const response = await request.post('/api/auth/register', {
   69 |       data: testUser
   70 |     });
   71 |     
   72 |     expect(response.status()).toBe(400);
   73 |     const body = await response.json();
   74 |     expect(body.message).toContain('already exists');
   75 |   });
   76 |
   77 |   test('should login with valid credentials', async ({ request }) => {
   78 |     const response = await request.post('/api/auth/login', {
   79 |       data: {
   80 |         login: testUser.email, // Use 'login' field instead of 'email'
   81 |         password: testUser.password
   82 |       }
   83 |     });
   84 |     
   85 |     expect(response.status()).toBe(200);
   86 |     const body = await response.json();
   87 |     expect(body).toHaveProperty('token');
   88 |     expect(body).toHaveProperty('user');
   89 |     expect(body.user.email).toBe(testUser.email);
   90 |   });
   91 |
   92 |   test('should not login with invalid credentials', async ({ request }) => {
   93 |     const response = await request.post('/api/auth/login', {
   94 |       data: {
   95 |         login: testUser.email,
   96 |         password: 'wrongpassword'
   97 |       }
   98 |     });
   99 |     
  100 |     expect(response.status()).toBe(400);
  101 |   });
  102 |
  103 |   test('should not login with non-existent user', async ({ request }) => {
  104 |     const response = await request.post('/api/auth/login', {
  105 |       data: {
  106 |         login: 'nonexistent@example.com',
  107 |         password: 'anypassword'
  108 |       }
  109 |     });
  110 |     
  111 |     expect(response.status()).toBe(400);
  112 |   });
  113 |
  114 |   test('should get user profile with valid token', async ({ request }) => {
  115 |     const response = await request.get('/api/auth/profile', {
  116 |       headers: {
  117 |         'Authorization': `Bearer ${authToken}`
  118 |       }
  119 |     });
  120 |     
> 121 |     expect(response.status()).toBe(200);
      |                               ^ Error: expect(received).toBe(expected) // Object.is equality
  122 |     const body = await response.json();
  123 |     expect(body.email).toBe(testUser.email);
  124 |     expect(body.firstName).toBe(testUser.firstName);
  125 |     expect(body).not.toHaveProperty('password');
  126 |   });
  127 |
  128 |   test('should not get profile without token', async ({ request }) => {
  129 |     const response = await request.get('/api/auth/profile');
  130 |     
  131 |     expect(response.status()).toBe(401);
  132 |   });
  133 |
  134 |   test('should not get profile with invalid token', async ({ request }) => {
  135 |     const response = await request.get('/api/auth/profile', {
  136 |       headers: {
  137 |         'Authorization': 'Bearer invalid-token'
  138 |       }
  139 |     });
  140 |     
  141 |     expect(response.status()).toBe(401);
  142 |   });
  143 |
  144 |   test('should update user profile', async ({ request }) => {
  145 |     const updateData = {
  146 |       firstName: 'Updated Test',
  147 |       lastName: 'User Updated',
  148 |       phone: '123456789'
  149 |     };
  150 |
  151 |     const response = await request.put('/api/auth/profile', {
  152 |       data: updateData,
  153 |       headers: {
  154 |         'Authorization': `Bearer ${authToken}`
  155 |       }
  156 |     });
  157 |     
  158 |     expect(response.status()).toBe(200);
  159 |     const body = await response.json();
  160 |     expect(body.firstName).toBe(updateData.firstName);
  161 |     expect(body.phone).toBe(updateData.phone);
  162 |   });
  163 |
  164 |   test('should not update profile without authentication', async ({ request }) => {
  165 |     const response = await request.put('/api/auth/profile', {
  166 |       data: { firstName: 'Should Not Update' }
  167 |     });
  168 |     
  169 |     expect(response.status()).toBe(401);
  170 |   });
  171 |
  172 |   test('should login as admin', async ({ request }) => {
  173 |     const response = await request.post('/api/auth/login', {
  174 |       data: adminUser
  175 |     });
  176 |     
  177 |     if (response.status() === 200) {
  178 |       const body = await response.json();
  179 |       expect(body).toHaveProperty('token');
  180 |       expect(body.user.role).toBe('Admin');
  181 |       adminToken = body.token;
  182 |     } else {
  183 |       console.log('Admin login failed - update admin credentials in test');
  184 |     }
  185 |   });
  186 | });
  187 |
```